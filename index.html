<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Mini App — Chart Game</title>

  <!-- Telegram WebApp (опционально, если открываешь внутри TG) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Lightweight Charts (график как на скрине) -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0b0614;
      --panel:#120824;
      --panel2:#0f0720;
      --stroke:rgba(255,255,255,.10);
      --text:#f2efff;
      --muted:rgba(242,239,255,.65);
      --green:#31d17c;
      --red:#ff4d4d;
      --purple:#7c4dff;
      --orange:#ff9d2e;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 60% 10%, rgba(124,77,255,.28), transparent 55%),
        radial-gradient(900px 520px at 20% 30%, rgba(49,209,124,.12), transparent 55%),
        radial-gradient(900px 520px at 85% 55%, rgba(255,77,77,.10), transparent 60%),
        linear-gradient(180deg, #070410, #0b0614 55%, #070410);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      padding: 12px 12px 22px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width: 0;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(124,77,255,.9), rgba(124,77,255,.25)),
                  radial-gradient(circle at 70% 70%, rgba(49,209,124,.65), rgba(49,209,124,.05));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(124,77,255,.25);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      line-height:1.1;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    .rightbar{
      display:flex; align-items:center; gap:10px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill strong{color:var(--text); font-weight:700}
    .tonDot{
      width:18px;height:18px;border-radius:999px;
      display:inline-grid; place-items:center;
      background: rgba(0, 166, 255, .15);
      border:1px solid rgba(0,166,255,.35);
      color:#8ad7ff;
      font-weight:800;
      font-size:11px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing:.2px;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      transition: transform .06s ease, filter .2s ease, background .2s ease;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,77,255,.95), rgba(124,77,255,.55));
      border:1px solid rgba(124,77,255,.75);
      box-shadow: 0 12px 30px rgba(124,77,255,.22);
    }
    .btn.orange{
      background: linear-gradient(180deg, rgba(255,157,46,.95), rgba(255,157,46,.55));
      border:1px solid rgba(255,157,46,.75);
      box-shadow: 0 12px 30px rgba(255,157,46,.20);
    }
    .btn.ghost{
      background: rgba(0,0,0,.18);
    }

    /* Tabs */
    .tabs{
      margin-top: 12px;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.3px;
      text-transform: uppercase;
      font-size: 12px;
      cursor:pointer;
      text-align:center;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(180deg, rgba(124,77,255,.28), rgba(0,0,0,.12));
      border-color: rgba(124,77,255,.45);
      box-shadow: 0 14px 38px rgba(124,77,255,.12);
    }

    /* Main layout */
    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns: 1fr}
      .topbar{position: static}
    }

    .card{
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Chart */
    .chartHead{
      padding: 12px 12px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .pair{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .pair .t{
      font-size:12px;
      color: var(--muted);
      font-weight:700;
    }
    .pair .v{
      font-size:14px;
      font-weight:1000;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stats{
      display:flex; align-items:center; gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .stat{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:11px;
      color: var(--muted);
    }
    .stat b{color:var(--text)}
    #chart{
      height: 360px;
      background: radial-gradient(900px 520px at 50% 0%, rgba(124,77,255,.30), rgba(124,77,255,.08) 45%, rgba(0,0,0,.10) 70%);
    }

    /* Right panel (bet) */
    .betWrap{
      padding: 12px;
    }
    .sectionTitle{
      font-size: 12px;
      font-weight: 1000;
      letter-spacing:.35px;
      text-transform: uppercase;
      color: var(--muted);
      margin: 2px 0 10px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .amountGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      margin-bottom: 10px;
    }
    .chip{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(255,157,46,.65);
      background: linear-gradient(180deg, rgba(255,157,46,.18), rgba(0,0,0,.18));
      box-shadow: 0 10px 25px rgba(255,157,46,.10);
    }

    .bigBox{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      margin-bottom: 10px;
    }
    .bigBox .label{font-size:11px;color:var(--muted);font-weight:800; text-transform:uppercase; letter-spacing:.25px}
    .bigBox .value{font-size:18px;font-weight:1100;margin-top:6px}

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .btnLong{
      background: linear-gradient(180deg, rgba(49,209,124,.95), rgba(49,209,124,.50));
      border:1px solid rgba(49,209,124,.70);
      box-shadow: 0 14px 34px rgba(49,209,124,.18);
    }
    .btnShort{
      background: linear-gradient(180deg, rgba(255,77,77,.95), rgba(255,77,77,.50));
      border:1px solid rgba(255,77,77,.70);
      box-shadow: 0 14px 34px rgba(255,77,77,.18);
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Footer strip like the game UI */
    .strip{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(255,255,255,.03));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .strip .badge{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(124,77,255,.35);
      background: rgba(124,77,255,.10);
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .strip .badge .p{
      width:18px;height:18px;border-radius:6px;
      display:inline-grid; place-items:center;
      background: rgba(124,77,255,.35);
      border:1px solid rgba(124,77,255,.55);
      font-size: 11px;
    }

    /* Bonus page */
    .bonus{
      padding: 16px;
    }
    .bonusBox{
      padding: 14px;
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      line-height: 1.4;
    }

    /* small */
    .mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1;}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <h1>PRO • CHART GAME</h1>
          <div class="sub" id="subline">Live rounds • Mini App</div>
        </div>
      </div>

      <div class="rightbar">
        <div class="pill" title="Баланс">
          <span class="tonDot">T</span>
          <span>Balance:</span>
          <strong class="mono" id="balTon">0.00</strong>
          <span>TON</span>
        </div>
        <button class="btn orange" id="btnTopup">Пополнить</button>
        <button class="btn primary" id="btnWallet">Кошелёк</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabTrade">Trade</button>
      <button class="tab" id="tabBonus">Bonus</button>
    </div>

    <!-- TRADE VIEW -->
    <div id="viewTrade">
      <div class="grid">

        <!-- Chart card -->
        <div class="card">
          <div class="chartHead">
            <div class="pair">
              <div class="t">Instrument</div>
              <div class="v" id="pairName">Slot Catalog • Synthetic</div>
            </div>

            <div class="stats">
              <div class="stat">Round: <b class="mono" id="roundId">—</b></div>
              <div class="stat">Time: <b class="mono" id="roundTimer">—</b></div>
              <div class="stat">Price: <b class="mono" id="lastPrice">—</b></div>
            </div>
          </div>

          <div id="chart"></div>
        </div>

        <!-- Bet panel -->
        <div class="card">
          <div class="betWrap">
            <div class="sectionTitle">Betting</div>

            <div class="amountGrid" id="chips">
              <div class="chip active" data-amt="0.1">0.10</div>
              <div class="chip" data-amt="0.2">0.20</div>
              <div class="chip" data-amt="0.5">0.50</div>
              <div class="chip" data-amt="1">1.00</div>
              <div class="chip" data-amt="2">2.00</div>
              <div class="chip" data-amt="5">5.00</div>
              <div class="chip" data-amt="10">10</div>
              <div class="chip" data-amt="20">20</div>
            </div>

            <div class="bigBox">
              <div class="label">Bet amount</div>
              <div class="value"><span class="mono" id="betAmt">0.10</span> TON</div>
            </div>

            <div class="bigBox">
              <div class="label">Your position</div>
              <div class="value mono" id="posStatus">No position</div>
            </div>

            <div class="actions">
              <button class="btn btnLong" id="btnLong">LONG ▲</button>
              <button class="btn btnShort" id="btnShort">SHORT ▼</button>
            </div>

            <div class="hint" id="hint">
              Нажми <b>LONG</b> или <b>SHORT</b> в течение раунда. Логику расчёта и бонусы подключим дальше.
            </div>
          </div>
        </div>

      </div>

      <div class="strip">
        <div class="badge">
          <span class="p">P</span>
          <span>PRO • UI</span>
        </div>
        <div class="pill">
          <span>Status:</span>
          <strong id="netStatus">connecting…</strong>
        </div>
      </div>
    </div>

    <!-- BONUS VIEW -->
    <div id="viewBonus" style="display:none;">
      <div class="card">
        <div class="bonus">
          <div class="sectionTitle">Bonus</div>
          <div class="bonusBox">
            Тут будет бонусная система (ежедневные бонусы, промокоды, задания и т.д.).<br/>
            Пока просто вкладка — функцию зададим позже.
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ---------------------------
    // Config
    // ---------------------------
    const API = ""; // если нужно проксировать на другой домен — поставь "https://xxx.vercel.app"
    const $ = (id) => document.getElementById(id);

    // Telegram WebApp init (не обязателен)
    const tg = window.Telegram?.WebApp;
    try {
      tg?.ready();
      tg?.expand();
    } catch(e){}

    // ---------------------------
    // Tabs
    // ---------------------------
    const tabTrade = $("tabTrade");
    const tabBonus = $("tabBonus");
    const viewTrade = $("viewTrade");
    const viewBonus = $("viewBonus");

    function setTab(name){
      const isTrade = name === "trade";
      tabTrade.classList.toggle("active", isTrade);
      tabBonus.classList.toggle("active", !isTrade);
      viewTrade.style.display = isTrade ? "" : "none";
      viewBonus.style.display = isTrade ? "none" : "";
    }
    tabTrade.onclick = () => setTab("trade");
    tabBonus.onclick = () => setTab("bonus");

    // ---------------------------
    // Chips
    // ---------------------------
    let selectedAmt = 0.10;
    $("chips").addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if(!chip) return;
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      selectedAmt = Number(chip.dataset.amt || "0.1");
      $("betAmt").textContent = selectedAmt.toFixed(2).replace(/\.00$/,".00");
    });

    // ---------------------------
    // Chart init
    // ---------------------------
    let chart, areaSeries, lastPrice = null;

    function initChart(){
      const el = $("chart");
      chart = LightweightCharts.createChart(el, {
        autoSize: true,
        layout: {
          background: { type: "solid", color: "transparent" },
          textColor: "rgba(242,239,255,.75)"
        },
        grid: {
          vertLines: { color: "rgba(255,255,255,.06)" },
          horzLines: { color: "rgba(255,255,255,.06)" }
        },
        rightPriceScale: {
          borderColor: "rgba(255,255,255,.12)",
          textColor: "rgba(242,239,255,.7)"
        },
        timeScale: {
          borderColor: "rgba(255,255,255,.12)",
          timeVisible: true,
          secondsVisible: true
        },
        crosshair: {
          vertLine: { color: "rgba(124,77,255,.45)" },
          horzLine: { color: "rgba(124,77,255,.35)" }
        }
      });

      areaSeries = chart.addAreaSeries({
        lineWidth: 2,
        lineColor: "rgba(49,209,124,.95)",
        topColor: "rgba(49,209,124,.35)",
        bottomColor: "rgba(49,209,124,.05)",
      });

      new ResizeObserver(() => chart.timeScale().fitContent()).observe(el);
    }

    function toChartData(series){
      // ожидаем формат [[ts_ms, price], ...]
      return (series || []).map(([ts, price]) => ({
        time: Math.floor(ts / 1000),
        value: Number(price)
      }));
    }

    // ---------------------------
    // API helpers
    // ---------------------------
    async function apiGet(path){
      const r = await fetch(API + path, { cache: "no-store" });
      if(!r.ok) throw new Error(path + " " + r.status);
      return await r.json();
    }

    async function apiPost(path, body){
      const r = await fetch(API + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      if(!r.ok) throw new Error(path + " " + r.status);
      return await r.json();
    }

    // ---------------------------
    // State / Series polling
    // ---------------------------
    let currentRound = null;
    let pos = null; // {side, amount, roundId}

    function fmtTime(ms){
      if(ms < 0) ms = 0;
      const s = Math.ceil(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    async function loadState(){
      const data = await apiGet("/api/state");
      currentRound = data.round || null;
      $("roundId").textContent = currentRound?.roundId ?? "—";

      const now = data.serverNow || Date.now();
      const endAt = currentRound?.endAt || (now + 10000);
      $("roundTimer").textContent = fmtTime(endAt - now);

      $("netStatus").textContent = "online";
    }

    async function loadSeries(){
      const data = await apiGet("/api/series");
      const series = toChartData(data.series);

      if(series.length){
        areaSeries.setData(series);
        lastPrice = series[series.length-1].value;
        $("lastPrice").textContent = String(lastPrice.toFixed(4));
      }
      $("netStatus").textContent = "online";
    }

    async function loadBalance(){
      // ожидаем, что /api/balance может брать user из initData на сервере
      const data = await apiGet("/api/balance");
      // попробуем разные поля (на всякий)
      const ton = Number(data.balanceTon ?? data.ton ?? data.balance ?? 0);
      $("balTon").textContent = ton.toFixed(2);
      $("netStatus").textContent = "online";
    }

    // ---------------------------
    // Actions: LONG / SHORT
    // ---------------------------
    function setPosStatus(){
      if(!pos){
        $("posStatus").textContent = "No position";
        return;
      }
      $("posStatus").textContent = `${pos.side.toUpperCase()} • ${pos.amount.toFixed(2)} TON • round ${pos.roundId}`;
    }

    async function place(side){
      if(!currentRound?.roundId){
        $("hint").textContent = "Нет активного раунда. Подожди…";
        return;
      }
      try{
        $("hint").textContent = "Отправляю ставку…";
        const payload = {
          side,                     // "long" | "short"
          amountTon: selectedAmt,   // сумма TON
          roundId: currentRound.roundId
          // если у тебя нужно ещё address/initData — сервер возьмёт из tg.initData или добавим позже
        };
        const res = await apiPost("/api/bet_place", payload);

        // ожидаем ok
        pos = { side, amount: selectedAmt, roundId: currentRound.roundId };
        setPosStatus();
        $("hint").textContent = "Ставка принята ✅";
        await loadBalance();
      }catch(e){
        console.error(e);
        $("hint").textContent = "Ошибка ставки: " + e.message;
        $("netStatus").textContent = "error";
      }
    }

    $("btnLong").onclick = () => place("long");
    $("btnShort").onclick = () => place("short");

    // ---------------------------
    // Wallet / Topup buttons (пока UI, логику сделаем следом)
    // ---------------------------
    $("btnWallet").onclick = async () => {
      // Тут позже подключим TON Connect UI как в твоём прошлом проекте
      $("hint").textContent = "Кошелёк: подключим TON Connect следующим шагом.";
      setTab("trade");
    };

    $("btnTopup").onclick = async () => {
      try{
        $("hint").textContent = "Создаю пополнение…";
        // deposit_intent: на сервере ты выдашь реквизиты/инвойс (как раньше)
        const res = await apiPost("/api/deposit_intent", { amountTon: selectedAmt });
        // Ожидаемо: res.payUrl или res.invoice или res.address+payload — под твой прошлый формат
        if(res.payUrl){
          // если сервер отдаёт ссылку
          window.open(res.payUrl, "_blank");
          $("hint").textContent = "Открыл ссылку на оплату.";
        }else{
          $("hint").textContent = "Intent создан. Следующим шагом подключим оплату (TON Connect).";
        }
      }catch(e){
        console.error(e);
        $("hint").textContent = "Ошибка пополнения: " + e.message;
      }
    };

    // ---------------------------
    // Boot
    // ---------------------------
    initChart();
    setPosStatus();

    async function boot(){
      try{
        await Promise.all([loadState(), loadSeries(), loadBalance()]);
      }catch(e){
        console.error(e);
        $("netStatus").textContent = "offline";
      }
    }

    boot();
    setInterval(() => loadState().catch(()=>{$("netStatus").textContent="offline";}), 1000);
    setInterval(() => loadSeries().catch(()=>{$("netStatus").textContent="offline";}), 1500);
    setInterval(() => loadBalance().catch(()=>{}), 5000);
  </script>
</body>
</html>
