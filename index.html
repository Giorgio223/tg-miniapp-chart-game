<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Chart Game</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Chart -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0b0614;
      --panel:#120824;
      --stroke:rgba(255,255,255,.10);
      --text:#f2efff;
      --muted:rgba(242,239,255,.65);
      --green:#31d17c;
      --red:#ff4d4d;
      --purple:#7c4dff;
      --orange:#ff9d2e;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 60% 10%, rgba(124,77,255,.28), transparent 55%),
        radial-gradient(900px 520px at 20% 30%, rgba(49,209,124,.12), transparent 55%),
        radial-gradient(900px 520px at 85% 55%, rgba(255,77,77,.10), transparent 60%),
        linear-gradient(180deg, #070410, #0b0614 55%, #070410);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      padding: 12px 12px 22px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(124,77,255,.9), rgba(124,77,255,.25)),
                  radial-gradient(circle at 70% 70%, rgba(49,209,124,.65), rgba(49,209,124,.05));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(124,77,255,.25);
    }

    .rightbar{
      display:flex; align-items:center; gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.2px;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      transition: transform .06s ease, filter .2s ease, background .2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,77,255,.95), rgba(124,77,255,.55));
      border:1px solid rgba(124,77,255,.75);
      box-shadow: 0 12px 30px rgba(124,77,255,.22);
    }
    .btn.orange{
      background: linear-gradient(180deg, rgba(255,157,46,.95), rgba(255,157,46,.55));
      border:1px solid rgba(255,157,46,.75);
      box-shadow: 0 12px 30px rgba(255,157,46,.20);
    }
    .btn.ghost{
      background: rgba(0,0,0,.18);
    }

    .tonIcon{
      width:18px;height:18px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill strong{color:var(--text); font-weight:1000}

    /* Main layout */
    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns: 1fr}
      .topbar{position: static}
    }

    .card{
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Chart */
    .chartHead{
      padding: 12px 12px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), transparent);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .pair{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .pair .t{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
    }
    .pair .v{
      font-size:14px;
      font-weight:1100;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stats{
      display:flex; align-items:center; gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .stat{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:11px;
      color: var(--muted);
    }
    .stat b{color:var(--text)}
    #chart{
      height: 360px;
      background: radial-gradient(900px 520px at 50% 0%, rgba(124,77,255,.30), rgba(124,77,255,.08) 45%, rgba(0,0,0,.10) 70%);
    }

    /* Right panel (bet) */
    .betWrap{ padding: 12px; }
    .sectionTitle{
      font-size: 12px;
      font-weight: 1100;
      letter-spacing:.35px;
      text-transform: uppercase;
      color: var(--muted);
      margin: 2px 0 10px;
    }

    .amountGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      margin-bottom: 10px;
    }
    .chip{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 1000;
      font-size: 12px;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(255,157,46,.65);
      background: linear-gradient(180deg, rgba(255,157,46,.18), rgba(0,0,0,.18));
      box-shadow: 0 10px 25px rgba(255,157,46,.10);
    }

    .bigBox{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      margin-bottom: 10px;
    }
    .bigBox .label{
      font-size:11px;color:var(--muted);font-weight:900;
      text-transform:uppercase; letter-spacing:.25px
    }
    .bigBox .value{font-size:18px;font-weight:1150;margin-top:6px}

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .btnLong{
      background: linear-gradient(180deg, rgba(49,209,124,.95), rgba(49,209,124,.50));
      border:1px solid rgba(49,209,124,.70);
      box-shadow: 0 14px 34px rgba(49,209,124,.18);
    }
    .btnShort{
      background: linear-gradient(180deg, rgba(255,77,77,.95), rgba(255,77,77,.50));
      border:1px solid rgba(255,77,77,.70);
      box-shadow: 0 14px 34px rgba(255,77,77,.18);
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .strip{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(255,255,255,.03));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }

    .mono{font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1;}

    /* Bonus overlay */
    .bonusOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 200;
      backdrop-filter: blur(8px);
    }
    .bonusSheet{
      width: min(560px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
      box-shadow: 0 26px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .bonusHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .bonusHead .t{
      font-weight:1100;
      letter-spacing:.3px;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--text);
    }
    .bonusBody{
      padding: 12px;
      color: var(--muted);
      line-height: 1.45;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
      </div>

      <div class="rightbar">
        <button class="btn ghost" id="btnBonus">BONUS</button>
        <button class="btn orange" id="btnTopup">Пополнить</button>

        <!-- Баланс как кнопка + иконка ton.png -->
        <button class="btn primary" id="btnBalance">
          <img class="tonIcon" src="/ton.png" alt="TON" />
          <span>Баланс:</span>
          <span class="mono" id="balTon">0.00</span>
        </button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="grid">

      <!-- Chart card -->
      <div class="card">
        <div class="chartHead">
          <div class="pair">
            <div class="t">Instrument</div>
            <div class="v" id="pairName">Slot Catalog • Synthetic</div>
          </div>

          <div class="stats">
            <div class="stat">Round: <b class="mono" id="roundId">—</b></div>
            <div class="stat">Time: <b class="mono" id="roundTimer">—</b></div>
            <div class="stat">Price: <b class="mono" id="lastPrice">—</b></div>
          </div>
        </div>

        <div id="chart"></div>
      </div>

      <!-- Bet panel -->
      <div class="card">
        <div class="betWrap">
          <div class="sectionTitle">Betting</div>

          <div class="amountGrid" id="chips">
            <div class="chip active" data-amt="0.1">0.10</div>
            <div class="chip" data-amt="0.2">0.20</div>
            <div class="chip" data-amt="0.5">0.50</div>
            <div class="chip" data-amt="1">1.00</div>
            <div class="chip" data-amt="2">2.00</div>
            <div class="chip" data-amt="5">5.00</div>
            <div class="chip" data-amt="10">10</div>
            <div class="chip" data-amt="20">20</div>
          </div>

          <div class="bigBox">
            <div class="label">Bet amount</div>
            <div class="value"><span class="mono" id="betAmt">0.10</span> TON</div>
          </div>

          <div class="bigBox">
            <div class="label">Your position</div>
            <div class="value mono" id="posStatus">No position</div>
          </div>

          <div class="actions">
            <button class="btn btnLong" id="btnLong">LONG ▲</button>
            <button class="btn btnShort" id="btnShort">SHORT ▼</button>
          </div>

          <div class="hint" id="hint">
            Нажми <b>LONG</b> или <b>SHORT</b> в течение раунда.
          </div>
        </div>
      </div>

    </div>

    <div class="strip">
      <div class="pill">
        <span>Status:</span>
        <strong id="netStatus">connecting…</strong>
      </div>
    </div>

  </div>

  <!-- BONUS SHEET -->
  <div class="bonusOverlay" id="bonusOverlay">
    <div class="bonusSheet">
      <div class="bonusHead">
        <div class="t">BONUS</div>
        <button class="btn ghost" id="btnBonusClose">Закрыть</button>
      </div>
      <div class="bonusBody">
        Тут будет бонусная система (ежедневные бонусы, задания, промокоды и т.д.).<br/>
        Пока это окно-заглушка — функцию зададим позже.
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Telegram WebApp init
    // ---------------------------
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); } catch(e){}

    // ---------------------------
    // Helpers
    // ---------------------------
    const API = ""; // если нужно на другой домен — поставь "https://xxx.vercel.app"
    const $ = (id) => document.getElementById(id);

    async function apiGet(path){
      const r = await fetch(API + path, { cache: "no-store" });
      if(!r.ok) throw new Error(path + " " + r.status);
      return await r.json();
    }

    async function apiPost(path, body){
      const r = await fetch(API + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      if(!r.ok) throw new Error(path + " " + r.status);
      return await r.json();
    }

    function openExternal(url){
      if(!url) return false;
      try{
        if (tg?.openTelegramLink && (url.startsWith("tg://") || url.includes("t.me/"))) {
          tg.openTelegramLink(url);
          return true;
        }
        if (tg?.openLink) {
          tg.openLink(url, { try_instant_view: false });
          return true;
        }
      }catch(e){}
      window.location.href = url;
      return true;
    }

    // ---------------------------
    // BONUS modal
    // ---------------------------
    const bonusOverlay = $("bonusOverlay");
    $("btnBonus").onclick = () => bonusOverlay.style.display = "flex";
    $("btnBonusClose").onclick = () => bonusOverlay.style.display = "none";
    bonusOverlay.addEventListener("click", (e) => {
      if(e.target === bonusOverlay) bonusOverlay.style.display = "none";
    });

    // ---------------------------
    // Chips
    // ---------------------------
    let selectedAmt = 0.10;

    $("chips").addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if(!chip) return;
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      selectedAmt = Number(chip.dataset.amt || "0.1");
      $("betAmt").textContent = selectedAmt.toFixed(2);
    });

    // ---------------------------
    // Chart init
    // ---------------------------
    let chart, areaSeries, lastPrice = null;

    function initChart(){
      const el = $("chart");
      chart = LightweightCharts.createChart(el, {
        autoSize: true,
        layout: {
          background: { type: "solid", color: "transparent" },
          textColor: "rgba(242,239,255,.75)"
        },
        grid: {
          vertLines: { color: "rgba(255,255,255,.06)" },
          horzLines: { color: "rgba(255,255,255,.06)" }
        },
        rightPriceScale: {
          borderColor: "rgba(255,255,255,.12)",
          textColor: "rgba(242,239,255,.7)"
        },
        timeScale: {
          borderColor: "rgba(255,255,255,.12)",
          timeVisible: true,
          secondsVisible: true
        },
        crosshair: {
          vertLine: { color: "rgba(124,77,255,.45)" },
          horzLine: { color: "rgba(124,77,255,.35)" }
        }
      });

      areaSeries = chart.addAreaSeries({
        lineWidth: 2,
        lineColor: "rgba(49,209,124,.95)",
        topColor: "rgba(49,209,124,.35)",
        bottomColor: "rgba(49,209,124,.05)",
      });

      new ResizeObserver(() => chart.timeScale().fitContent()).observe(el);
    }

    function toChartData(series){
      // ожидаем формат [[ts_ms, price], ...]
      return (series || []).map(([ts, price]) => ({
        time: Math.floor(ts / 1000),
        value: Number(price)
      }));
    }

    // ---------------------------
    // State / Series / Balance
    // ---------------------------
    let currentRound = null;
    let pos = null; // {side, amount, roundId}

    function fmtTime(ms){
      if(ms < 0) ms = 0;
      const s = Math.ceil(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    function setPosStatus(){
      if(!pos){ $("posStatus").textContent = "No position"; return; }
      $("posStatus").textContent = `${pos.side.toUpperCase()} • ${pos.amount.toFixed(2)} TON • round ${pos.roundId}`;
    }

    async function loadState(){
      const data = await apiGet("/api/state");
      currentRound = data.round || null;
      $("roundId").textContent = currentRound?.roundId ?? "—";

      const now = data.serverNow || Date.now();
      const endAt = currentRound?.endAt || (now + 10000);
      $("roundTimer").textContent = fmtTime(endAt - now);

      $("netStatus").textContent = "online";
    }

    async function loadSeries(){
      const data = await apiGet("/api/series");
      const series = toChartData(data.series);

      if(series.length){
        areaSeries.setData(series);
        lastPrice = series[series.length-1].value;
        $("lastPrice").textContent = String(lastPrice.toFixed(4));
      }
      $("netStatus").textContent = "online";
    }

    async function loadBalance(){
      const data = await apiGet("/api/balance");
      const ton = Number(data.balanceTon ?? data.ton ?? data.balance ?? 0);
      $("balTon").textContent = ton.toFixed(2);
      $("netStatus").textContent = "online";
    }

    // ---------------------------
    // LONG / SHORT
    // ---------------------------
    async function place(side){
      if(!currentRound?.roundId){
        $("hint").textContent = "Нет активного раунда. Подожди…";
        return;
      }
      try{
        $("hint").textContent = "Отправляю ставку…";
        const payload = {
          side,                     // "long" | "short"
          amountTon: selectedAmt,   // сумма TON
          roundId: currentRound.roundId
        };
        await apiPost("/api/bet_place", payload);

        pos = { side, amount: selectedAmt, roundId: currentRound.roundId };
        setPosStatus();
        $("hint").textContent = "Ставка принята ✅";
        await loadBalance();
      }catch(e){
        console.error(e);
        $("hint").textContent = "Ошибка ставки: " + e.message;
        $("netStatus").textContent = "error";
      }
    }

    $("btnLong").onclick = () => place("long");
    $("btnShort").onclick = () => place("short");

    // ---------------------------
    // Buttons: TOPUP / BALANCE
    // ---------------------------
    $("btnBalance").onclick = async () => {
      // просто обновим баланс
      try{
        $("hint").textContent = "Обновляю баланс…";
        await loadBalance();
        $("hint").textContent = "Баланс обновлён ✅";
      }catch(e){
        $("hint").textContent = "Не удалось получить баланс: " + e.message;
      }
    };

    $("btnTopup").onclick = async () => {
      try{
        $("hint").textContent = "Создаю пополнение…";
        // твой сервер может ожидать amountTon / amountNano — пока шлём amountTon
        const res = await apiPost("/api/deposit_intent", { amountTon: selectedAmt });

        // поддержим разные форматы ответа (как у людей обычно бывает)
        const payUrl = res.payUrl || res.url || res.paymentUrl || res.link || res.invoiceLink;
        if(payUrl){
          openExternal(payUrl);
          $("hint").textContent = "Открываю оплату…";
        }else{
          $("hint").textContent = "deposit_intent создан, но сервер не вернул ссылку (payUrl).";
        }
      }catch(e){
        console.error(e);
        $("hint").textContent = "Ошибка пополнения: " + e.message;
      }
    };

    // ---------------------------
    // Boot
    // ---------------------------
    initChart();
    setPosStatus();

    async function boot(){
      try{
        await Promise.all([loadState(), loadSeries(), loadBalance()]);
      }catch(e){
        console.error(e);
        $("netStatus").textContent = "offline";
      }
    }

    boot();
    setInterval(() => loadState().catch(()=>{$("netStatus").textContent="offline";}), 1000);
    setInterval(() => loadSeries().catch(()=>{$("netStatus").textContent="offline";}), 1500);
    setInterval(() => loadBalance().catch(()=>{}), 5000);
  </script>
</body>
</html>
